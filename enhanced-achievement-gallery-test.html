<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Achievement Gallery Test - Dharmapala Shield</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/ui-screens.css">
    <link rel="stylesheet" href="css/enhancedAchievementGallery.css">
    <style>
        body { 
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: white;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        
        .test-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 10px;
            border: 1px solid #4ecdc4;
        }
        
        .test-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .test-btn {
            padding: 8px 16px;
            background: #4ecdc4;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .test-btn:hover {
            background: #45b7aa;
            transform: translateY(-2px);
        }
        
        .test-btn.secondary {
            background: #666;
            color: white;
        }
        
        .test-btn.secondary:hover {
            background: #777;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        .test-section h3 {
            color: #4ecdc4;
            margin-top: 0;
            border-bottom: 1px solid rgba(78, 205, 196, 0.3);
            padding-bottom: 10px;
        }
        
        .demo-achievement-screen {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #4ecdc4;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .demo-achievement-screen h2 {
            text-align: center;
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 32px;
        }
        
        .achievement-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            min-width: 100px;
        }
        
        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .stat-label {
            display: block;
            font-size: 14px;
            color: #ccc;
            margin-top: 5px;
        }
        
        .achievement-categories {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .category-btn {
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.5);
            color: #4ecdc4;
            border: 1px solid #4ecdc4;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .category-btn:hover {
            background: rgba(78, 205, 196, 0.1);
        }
        
        .category-btn.active {
            background: #4ecdc4;
            color: #000;
            font-weight: bold;
        }
        
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .achievement-item {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }
        
        .achievement-item:hover {
            border-color: #4ecdc4;
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.2);
            transform: translateY(-2px);
        }
        
        .achievement-item.unlocked {
            border-color: #4caf50;
        }
        
        .achievement-item.locked {
            opacity: 0.7;
        }
        
        .achievement-icon {
            font-size: 32px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }
        
        .achievement-info {
            flex: 1;
            min-width: 0;
        }
        
        .achievement-title {
            font-size: 16px;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }
        
        .achievement-description {
            font-size: 14px;
            color: #ccc;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .achievement-status {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            flex-shrink: 0;
        }
        
        .log-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            border: 1px solid #666;
        }
        
        .log-content {
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            color: #ccc;
            white-space: pre-wrap;
        }
        
        @media (max-width: 768px) {
            .achievement-grid {
                grid-template-columns: 1fr;
            }
            
            .test-controls {
                justify-content: center;
            }
            
            .achievement-stats {
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üõ°Ô∏è Enhanced Achievement Gallery Test</h1>
            <p>Testing advanced search, filtering, and sorting functionality for Dharmapala Shield</p>
        </div>

        <div class="test-controls">
            <button class="test-btn" onclick="initializeTestData()">Initialize Test Data</button>
            <button class="test-btn" onclick="testSearchFunctionality()">Test Search</button>
            <button class="test-btn" onclick="testProgressFiltering()">Test Progress Filtering</button>
            <button class="test-btn" onclick="testSortingOptions()">Test Sorting</button>
            <button class="test-btn" onclick="testNearCompletionFilter()">Test Near Completion</button>
            <button class="test-btn secondary" onclick="resetTestState()">Reset Test</button>
            <button class="test-btn secondary" onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h3>Enhanced Achievement Gallery Demo</h3>
            
            <!-- Mock Achievement Screen -->
            <div id="achievementScreen" class="demo-achievement-screen">
                <h2>Achievement Gallery</h2>
                
                <div class="achievement-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="achievementProgress">0/25</span>
                        <span class="stat-label">Unlocked</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="achievementPercentage">0%</span>
                        <span class="stat-label">Complete</span>
                    </div>
                </div>
                
                <div class="achievement-categories">
                    <button class="category-btn active" data-category="all">All</button>
                    <button class="category-btn" data-category="first_steps">First Steps</button>
                    <button class="category-btn" data-category="combat">Combat</button>
                    <button class="category-btn" data-category="strategy">Strategy</button>
                    <button class="category-btn" data-category="progression">Progression</button>
                    <button class="category-btn" data-category="secret">Secrets</button>
                </div>
                
                <!-- Enhanced controls will be inserted here -->
                <div id="achievementResultsSummary"></div>
                <div class="achievement-grid" id="achievementGrid">
                    <!-- Achievement items will be populated dynamically -->
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>Feature Test Results</h3>
            <div class="log-section">
                <div class="log-content" id="testLog"></div>
            </div>
        </div>
    </div>

    <!-- Load required scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/saveSystem.js"></script>
    <script src="js/achievementManager.js"></script>
    <script src="js/enhancedAchievementGallery.js"></script>

    <script>
        // Test environment setup
        let testGame = null;
        let testAchievementManager = null;
        let testEnhancedGallery = null;

        // Mock game class for testing
        class MockGame {
            constructor() {
                this.achievementManager = null;
                this.enhancedAchievementGallery = null;
            }
            
            playSfx(sound) {
                logToTest(`üîä Playing sound: ${sound}`);
            }
            
            showAchievementScreen() {
                logToTest('üñ•Ô∏è Achievement screen opened');
            }
        }

        // Mock save system
        const mockSaveSystem = {
            loadData: () => ({ achievements: {} }),
            saveData: (data) => logToTest(`üíæ Saved data: ${JSON.stringify(data).length} characters`)
        };

        // Logging function
        function logToTest(message) {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').textContent = '';
        }

        // Initialize test data
        function initializeTestData() {
            try {
                logToTest('üöÄ Initializing test environment...');
                
                // Create mock game and systems
                testGame = new MockGame();
                testAchievementManager = new AchievementManager(mockSaveSystem, null);
                
                // Create enhanced gallery
                testEnhancedGallery = new EnhancedAchievementGallery(testGame, testAchievementManager);
                
                // Set up test data
                setupTestAchievements();
                
                // Initialize the enhanced gallery
                testEnhancedGallery.refreshAchievementData();
                
                logToTest('‚úÖ Test environment initialized successfully');
                logToTest(`üìä Total achievements: ${testAchievementManager.getAllAchievements().length}`);
                
                // Update stats display
                updateStatsDisplay();
                
            } catch (error) {
                logToTest(`‚ùå Error initializing test data: ${error.message}`);
                console.error('Test initialization error:', error);
            }
        }

        // Setup test achievements with various progress states
        function setupTestAchievements() {
            // Unlock some achievements with different timestamps
            const achievementIds = Object.keys(testAchievementManager.achievements);
            
            // Unlock 40% of achievements
            const toUnlock = Math.floor(achievementIds.length * 0.4);
            for (let i = 0; i < toUnlock; i++) {
                const achievementId = achievementIds[i];
                testAchievementManager.unlockAchievement(achievementId);
                
                // Set different unlock timestamps
                testAchievementManager.recentUnlocks.push({
                    id: achievementId,
                    timestamp: Date.now() - (Math.random() * 7 * 24 * 60 * 60 * 1000) // Random time within last week
                });
            }
            
            // Set partial progress for some achievements
            const remaining = achievementIds.slice(toUnlock);
            for (let i = 0; i < remaining.length * 0.5; i++) {
                const achievementId = remaining[i];
                const achievement = testAchievementManager.achievements[achievementId];
                
                if (achievement.condition && achievement.condition.type === 'cumulative') {
                    const target = achievement.condition.target || 10;
                    const progress = Math.floor(Math.random() * target * 0.9); // 0-90% progress
                    testAchievementManager.progressTracking[achievementId] = progress;
                }
            }
            
            logToTest(`üéØ Set up ${toUnlock} unlocked achievements`);
            logToTest(`‚è≥ Set up ${Math.floor(remaining.length * 0.5)} achievements with partial progress`);
        }

        // Update stats display
        function updateStatsDisplay() {
            if (!testAchievementManager) return;
            
            const stats = testAchievementManager.getAchievementStats();
            const progressElement = document.getElementById('achievementProgress');
            const percentageElement = document.getElementById('achievementPercentage');
            
            if (progressElement) {
                progressElement.textContent = `${stats.unlocked}/${stats.total}`;
            }
            
            if (percentageElement) {
                percentageElement.textContent = `${stats.percentage}%`;
            }
        }

        // Test search functionality
        function testSearchFunctionality() {
            if (!testEnhancedGallery) {
                logToTest('‚ùå Enhanced gallery not initialized. Run "Initialize Test Data" first.');
                return;
            }
            
            logToTest('üîç Testing search functionality...');
            
            // Test various search terms
            const searchTerms = ['first', 'combat', 'defense', 'level', 'master'];
            
            searchTerms.forEach(term => {
                const results = testEnhancedGallery.searchAchievements(term);
                logToTest(`   Search "${term}": ${results.length} results`);
            });
            
            // Test empty search
            const allResults = testEnhancedGallery.searchAchievements('');
            logToTest(`   Empty search: ${allResults.length} results (should show all)`);
            
            logToTest('‚úÖ Search functionality test completed');
        }

        // Test progress-based filtering
        function testProgressFiltering() {
            if (!testEnhancedGallery) {
                logToTest('‚ùå Enhanced gallery not initialized. Run "Initialize Test Data" first.');
                return;
            }
            
            logToTest('üìä Testing progress-based filtering...');
            
            const filters = ['all', 'completed', 'in-progress', 'locked'];
            
            filters.forEach(filter => {
                testEnhancedGallery.currentFilter.progressStatus = filter;
                testEnhancedGallery.applyFiltersAndSort();
                
                const results = testEnhancedGallery.filteredAchievements.length;
                logToTest(`   Filter "${filter}": ${results} achievements`);
            });
            
            logToTest('‚úÖ Progress filtering test completed');
        }

        // Test sorting options
        function testSortingOptions() {
            if (!testEnhancedGallery) {
                logToTest('‚ùå Enhanced gallery not initialized. Run "Initialize Test Data" first.');
                return;
            }
            
            logToTest('üî¢ Testing sorting options...');
            
            const sortOptions = [
                { sortBy: 'name', sortOrder: 'asc' },
                { sortBy: 'name', sortOrder: 'desc' },
                { sortBy: 'unlock-date', sortOrder: 'desc' },
                { sortBy: 'progress', sortOrder: 'desc' },
                { sortBy: 'difficulty', sortOrder: 'asc' },
                { sortBy: 'category', sortOrder: 'asc' }
            ];
            
            sortOptions.forEach(option => {
                testEnhancedGallery.currentFilter.sortBy = option.sortBy;
                testEnhancedGallery.currentFilter.sortOrder = option.sortOrder;
                testEnhancedGallery.applyFiltersAndSort();
                
                const firstItem = testEnhancedGallery.filteredAchievements[0];
                const lastItem = testEnhancedGallery.filteredAchievements[testEnhancedGallery.filteredAchievements.length - 1];
                
                logToTest(`   Sort by ${option.sortBy} (${option.sortOrder}): "${firstItem?.name}" to "${lastItem?.name}"`);
            });
            
            logToTest('‚úÖ Sorting options test completed');
        }

        // Test near completion filter
        function testNearCompletionFilter() {
            if (!testEnhancedGallery) {
                logToTest('‚ùå Enhanced gallery not initialized. Run "Initialize Test Data" first.');
                return;
            }
            
            logToTest('üéØ Testing near completion filter...');
            
            // Get achievements near completion
            const nearCompletion = testEnhancedGallery.getNearCompletionAchievements(0.7);
            logToTest(`   Found ${nearCompletion.length} achievements near completion (70%+ progress)`);
            
            // Test different thresholds
            const thresholds = [0.5, 0.7, 0.8, 0.9];
            thresholds.forEach(threshold => {
                const results = testEnhancedGallery.getNearCompletionAchievements(threshold);
                logToTest(`   Threshold ${threshold * 100}%: ${results.length} achievements`);
            });
            
            // Test filter toggle
            testEnhancedGallery.toggleNearCompletionFilter();
            logToTest(`   Near completion filter active: ${testEnhancedGallery.currentFilter.nearCompletion}`);
            
            testEnhancedGallery.toggleNearCompletionFilter();
            logToTest(`   Near completion filter toggled off: ${testEnhancedGallery.currentFilter.nearCompletion}`);
            
            logToTest('‚úÖ Near completion filter test completed');
        }

        // Reset test state
        function resetTestState() {
            if (testEnhancedGallery) {
                testEnhancedGallery.resetAllFilters();
                testEnhancedGallery.refreshAchievementData();
                logToTest('üîÑ Test state reset to defaults');
            } else {
                logToTest('‚ùå No enhanced gallery to reset');
            }
        }

        // Comprehensive test suite
        function runFullTestSuite() {
            logToTest('üß™ Running comprehensive test suite...');
            
            setTimeout(() => initializeTestData(), 100);
            setTimeout(() => testSearchFunctionality(), 500);
            setTimeout(() => testProgressFiltering(), 1000);
            setTimeout(() => testSortingOptions(), 1500);
            setTimeout(() => testNearCompletionFilter(), 2000);
            setTimeout(() => {
                logToTest('üéâ Comprehensive test suite completed!');
                logToTest('üìã All enhanced achievement gallery features tested successfully.');
            }, 2500);
        }

        // Auto-run test suite on page load
        window.addEventListener('load', () => {
            logToTest('üåü Enhanced Achievement Gallery Test Environment Ready');
            logToTest('Click "Initialize Test Data" to begin testing all features.');
            logToTest('');
            
            // Run a quick demo
            setTimeout(() => {
                logToTest('üöÄ Auto-running demo...');
                runFullTestSuite();
            }, 1000);
        });
    </script>
</body>
</html>
